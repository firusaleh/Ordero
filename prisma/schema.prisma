// prisma/schema-mongodb.prisma
// MongoDB-optimiertes Schema für Oriido

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

// ============================================
// BENUTZER & AUTHENTIFIZIERUNG
// ============================================

model User {
  id            String    @id @default(auto()) @map("_id") @db.ObjectId
  email         String    @unique
  emailVerified DateTime?
  password      String?
  name          String?
  phone         String?
  image         String?
  role          String    @default("RESTAURANT_OWNER") // SUPER_ADMIN, RESTAURANT_OWNER, RESTAURANT_STAFF
  
  // Stripe
  stripeCustomerId String?
  
  // Relationen
  ownedRestaurants Restaurant[] @relation("RestaurantOwner")
  staffAt          RestaurantStaff[]
  
  // Timestamps
  // Passwort-Zurücksetzen
  resetToken       String?
  resetTokenExpiry DateTime?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // NextAuth
  accounts Account[]
  sessions Session[]
}

model Account {
  id                String  @id @default(auto()) @map("_id") @db.ObjectId
  userId            String  @db.ObjectId
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(auto()) @map("_id") @db.ObjectId
  sessionToken String   @unique
  userId       String   @db.ObjectId
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// ============================================
// RESTAURANT
// ============================================

model Restaurant {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  name        String
  slug        String   @unique
  description String?
  cuisine     String?
  
  // Adresse
  street      String?
  city        String?
  postalCode  String?
  country     String   @default("DE") // DE, JO, SA, AE, etc.
  
  // Kontakt
  phone       String?
  email       String?
  website     String?
  
  // Aussehen
  logo        String?
  banner      String?
  primaryColor String? @default("#3b82f6")
  
  // Status & Plan
  status      String   @default("ACTIVE") // PENDING, ACTIVE, SUSPENDED, CANCELLED
  plan        String   @default("FREE")  // FREE, STANDARD, PREMIUM
  trialEndsAt DateTime?
  
  // Owner
  ownerId     String   @db.ObjectId
  owner       User     @relation("RestaurantOwner", fields: [ownerId], references: [id])
  
  // Relationen
  staff       RestaurantStaff[]
  categories  Category[]
  menuItems   MenuItem[]
  tables      Table[]
  orders      Order[]
  settings    RestaurantSettings?
  payments    Payment[]
  invoices    Invoice[]
  reservations Reservation[]
  preOrders   PreOrder[]
  pendingPayments PendingPayment[]

  // Stripe Platform (für Abonnements)
  stripeCustomerId       String?
  stripeSubscriptionId   String?
  stripePriceId         String?
  stripeCurrentPeriodEnd DateTime?
  subscriptionStatus     String?   @default("FREE") // FREE, ACTIVE, CANCELLED, PAST_DUE
  subscriptionPlan       String?   @default("FREE") // FREE, STANDARD, PREMIUM, JO_PAY_PER_ORDER, DE_PAY_PER_ORDER, DE_MONTHLY, DE_YEARLY
  subscriptionCurrentPeriodEnd DateTime?
  
  // Pay-per-Order Billing
  billingEnabled          Boolean @default(false)
  payPerOrderEnabled      Boolean @default(false)
  payPerOrderRate         Float?  // Rate pro Bestellung (0.10 für JO, 0.35 für DE)
  monthlyOrderCount       Int @default(0) // Zähler für Bestellungen im aktuellen Monat
  lastBillingDate         DateTime? // Letztes Abrechnungsdatum
  
  // Stripe Connect (für Zahlungsabwicklung)
  stripeAccountId        String?   // Connected Stripe Account ID
  stripeAccountStatus    String?   // restricted, enabled, complete
  stripeChargesEnabled   Boolean   @default(false)
  stripePayoutsEnabled   Boolean   @default(false)
  stripeDetailsSubmitted Boolean   @default(false)
  stripeOnboardingCompleted Boolean @default(false)
  
  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model RestaurantStaff {
  id           String   @id @default(auto()) @map("_id") @db.ObjectId
  restaurantId String   @db.ObjectId
  userId       String   @db.ObjectId
  role         String   @default("STAFF") // MANAGER, STAFF
  
  restaurant Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  user       User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@unique([restaurantId, userId])
}

model RestaurantSettings {
  id           String   @id @default(auto()) @map("_id") @db.ObjectId
  restaurantId String   @unique @db.ObjectId
  restaurant   Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  
  // Bestelleinstellungen
  orderingEnabled    Boolean @default(true)
  requireTableNumber Boolean @default(true)
  allowTakeaway     Boolean @default(false)
  allowDelivery     Boolean @default(false)
  autoAcceptOrders  Boolean @default(false)
  orderPrefix       String  @default("ORD")
  
  // Benachrichtigungen
  emailNotifications  Boolean @default(true)
  soundNotifications  Boolean @default(true)
  sendOrderEmails    Boolean @default(true)
  sendStatusUpdates  Boolean @default(true)
  notificationEmail  String?
  
  // Öffnungszeiten (als embedded document)
  openingHours       String? // JSON String mit Öffnungszeiten
  
  // Zahlungen
  acceptCash         Boolean @default(true)
  acceptCard         Boolean @default(false)
  acceptPaypal       Boolean @default(false)
  acceptStripe       Boolean @default(false)
  acceptPaytabs      Boolean @default(false)
  
  // Steuern
  taxRate            Float   @default(19)
  includeTax         Boolean @default(true)
  
  // Service Fee (Legacy - wird durch customFees ersetzt)
  serviceFeeEnabled  Boolean @default(false)
  serviceFeePercent  Float   @default(0)
  serviceFeeAmount   Float   @default(0)
  serviceFeeType     String  @default("PERCENT") // PERCENT or FIXED
  
  // Custom Fees
  customFees         CustomFee[]
  
  // Sprache & Währung
  currency          String  @default("EUR")
  language          String  @default("de")
  timezone          String  @default("Europe/Berlin")
  dateFormat        String  @default("DD.MM.YYYY")
  timeFormat        String  @default("24h")
  
  // POS Integration
  posSystem         String?  // ready2order, orderbird, gastrofix
  posApiKey         String?
  posRestaurantId   String?
  posSyncEnabled    Boolean @default(false)
  posLastSync       DateTime?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ============================================
// SPEISEKARTE
// ============================================

model Category {
  id           String   @id @default(auto()) @map("_id") @db.ObjectId
  restaurantId String   @db.ObjectId
  restaurant   Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  
  name         String
  description  String?
  icon         String?  // Icon-Name für UI
  color        String?  // Hex-Farbe
  image        String?  // Kategorie-Bild
  
  sortOrder    Int      @default(0)
  isActive     Boolean  @default(true)
  
  // Relationen
  menuItems    MenuItem[]
  
  // POS Mapping
  posId        String?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model MenuItem {
  id           String   @id @default(auto()) @map("_id") @db.ObjectId
  categoryId   String   @db.ObjectId
  category     Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  
  restaurantId String   @db.ObjectId
  restaurant   Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  
  name         String
  description  String?
  price        Float
  image        String?
  
  // Status
  isActive     Boolean  @default(true)
  isAvailable  Boolean  @default(true)
  
  // Zusatzinfos
  allergens    String[] // Array von Allergenen
  additives    String[] // Array von Zusatzstoffen
  tags         String[] // vegan, vegetarisch, scharf, etc.
  calories     Int?
  
  // Varianten & Extras (embedded documents)
  variants     MenuItemVariant[]
  extras       MenuItemExtra[]
  
  sortOrder    Int      @default(0)
  
  // POS Mapping
  posId        String?
  
  // Relationen
  orderItems   OrderItem[]
  preOrderItems PreOrderItem[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

type MenuItemVariant {
  id         String
  name       String
  price      Float
  sortOrder  Int     @default(0)
  posId      String?
}

type MenuItemExtra {
  id         String
  name       String
  price      Float
  sortOrder  Int     @default(0)
  posId      String?
}

// ============================================
// TISCHE & QR-CODES
// ============================================

model Table {
  id           String   @id @default(auto()) @map("_id") @db.ObjectId
  restaurantId String   @db.ObjectId
  restaurant   Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  
  number       Int
  name         String   // z.B. "Tisch 1", "Terrasse 3"
  seats        Int      @default(4)
  area         String?  // Bereich: "Innen", "Terrasse", etc.
  
  qrCode       String   // URL zum QR-Code
  isActive     Boolean  @default(true)
  
  // Relationen
  orders       Order[]
  reservations Reservation[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@unique([restaurantId, number])
}

// ============================================
// BESTELLUNGEN
// ============================================

model Order {
  id           String   @id @default(auto()) @map("_id") @db.ObjectId
  restaurantId String   @db.ObjectId
  restaurant   Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  
  orderNumber  String   @unique
  
  // Optional: Tisch-Zuordnung
  tableId      String?  @db.ObjectId
  table        Table?   @relation(fields: [tableId], references: [id])
  tableNumber  Int?
  
  // Bestelldetails
  type         String   @default("DINE_IN") // DINE_IN, TAKEAWAY
  status       String   @default("PENDING") // PENDING, CONFIRMED, PREPARING, READY, DELIVERED, CANCELLED, PAID
  
  // Preise
  subtotal     Float
  tax          Float
  serviceFee   Float    @default(0)
  total        Float
  
  // Gast-Info (optional)
  guestName    String?
  guestPhone   String?
  guestEmail   String?
  notes        String?
  
  // Zahlungsinformationen
  paymentStatus String  @default("PENDING") // PENDING, PAID, REFUNDED
  paymentMethod String? // CASH, CARD, PAYPAL, STRIPE
  paidAt       DateTime?
  
  // Stripe IDs
  paymentIntentId String?
  checkoutSessionId String?
  
  // Trinkgeld & Service
  tip          Float?   @default(0)
  tipPercent   Int?     // 5, 10, 15, 20
  
  // Kunde
  customerEmail String?
  customerPhone String?
  
  // Zeiten
  confirmedAt  DateTime?
  preparedAt   DateTime?
  readyAt      DateTime?
  deliveredAt  DateTime?
  completedAt  DateTime?
  cancelledAt  DateTime?
  
  // Relationen
  items        OrderItem[]
  invoice      Invoice?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model OrderItem {
  id         String   @id @default(auto()) @map("_id") @db.ObjectId
  orderId    String   @db.ObjectId
  order      Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  
  menuItemId String   @db.ObjectId
  menuItem   MenuItem @relation(fields: [menuItemId], references: [id])
  
  name       String   // Snapshot des Namens
  quantity   Int      @default(1)
  unitPrice  Float
  totalPrice Float
  
  // Ausgewählte Variante
  variant      String?
  variantPrice Float?
  
  // Ausgewählte Extras (als Array)
  extras     OrderItemExtra[]
  
  // Notizen
  notes      String?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

type OrderItemExtra {
  name  String
  price Float
}

// ============================================
// RESERVIERUNGEN & VORBESTELLUNGEN
// ============================================

model Reservation {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId
  restaurantId  String   @db.ObjectId
  restaurant    Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  
  tableId       String?  @db.ObjectId
  table         Table?   @relation(fields: [tableId], references: [id])
  
  // Kunde
  customerName  String
  customerEmail String
  customerPhone String
  numberOfGuests Int
  
  // Zeitpunkt
  reservationDate DateTime
  reservationTime String   // z.B. "19:00"
  duration        Int      @default(120) // in Minuten
  
  // Status
  status        String   @default("PENDING") // PENDING, CONFIRMED, CANCELLED, COMPLETED, NO_SHOW
  
  // Notizen
  notes         String?
  specialRequests String?
  
  // Vorbestellung (optional)
  preOrderId    String?  @db.ObjectId
  preOrder      PreOrder? @relation(fields: [preOrderId], references: [id])
  
  // Bestätigung
  confirmationToken String?
  confirmedAt   DateTime?
  cancelledAt   DateTime?
  cancelReason  String?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([restaurantId, reservationDate])
  @@index([status])
}

model PreOrder {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId
  restaurantId  String   @db.ObjectId
  restaurant    Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  
  // Kunde
  customerName  String
  customerEmail String
  customerPhone String
  
  // Pickup/Delivery Zeit
  pickupTime    DateTime
  orderType     String   @default("PICKUP") // PICKUP, DINE_IN
  
  // Verknüpfung mit Reservierung (optional)
  reservations  Reservation[]
  
  // Status
  status        String   @default("PENDING") // PENDING, CONFIRMED, PREPARING, READY, COMPLETED, CANCELLED
  
  // Bestelldetails
  items         PreOrderItem[]
  
  // Preise
  subtotal      Float
  tax           Float
  serviceFee    Float    @default(0)
  total         Float
  
  // Zahlung
  paymentStatus String   @default("PENDING") // PENDING, PAID, REFUNDED
  paymentMethod String?  // CASH, CARD, ONLINE
  paidAt        DateTime?
  
  // Stripe
  stripePaymentIntentId String?
  
  // Notizen
  notes         String?
  
  // Benachrichtigungen
  notificationSent Boolean @default(false)
  reminderSent    Boolean @default(false)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([restaurantId, pickupTime])
  @@index([status])
}

model PreOrderItem {
  id           String   @id @default(auto()) @map("_id") @db.ObjectId
  preOrderId   String   @db.ObjectId
  preOrder     PreOrder @relation(fields: [preOrderId], references: [id], onDelete: Cascade)
  
  menuItemId   String   @db.ObjectId
  menuItem     MenuItem @relation(fields: [menuItemId], references: [id])
  
  name         String   // Snapshot des Namens
  quantity     Int      @default(1)
  unitPrice    Float
  totalPrice   Float
  
  // Variante
  variant      String?
  variantPrice Float?
  
  // Extras
  extras       PreOrderItemExtra[]
  
  // Notizen
  notes        String?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

type PreOrderItemExtra {
  name  String
  price Float
}

// ============================================
// RECHNUNGEN & ZAHLUNGEN
// ============================================

model Invoice {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId
  invoiceNumber String   @unique
  restaurantId  String   @db.ObjectId
  restaurant    Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  
  // Order Relation (optional)
  orderId       String?  @unique @db.ObjectId
  order         Order?   @relation(fields: [orderId], references: [id])
  
  // Beträge
  subtotal      Float
  taxRate       Float    @default(19) // 19% oder 7%
  tax           Float
  tip           Float    @default(0)
  total         Float
  
  // Status
  status        String   @default("DRAFT") // DRAFT, SENT, PAID, OVERDUE, CANCELLED
  
  // Daten
  dueDate       DateTime
  
  // Zahlungsinformationen
  paidAt        DateTime?
  paymentMethod String?
  
  // Items (als embedded document)
  items         InvoiceItem[]
  
  // Kunde
  customerName  String?
  customerEmail String?
  customerPhone String?
  customerAddress String?
  
  // Stripe
  stripeInvoiceId String?
  stripePdfUrl    String?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

type InvoiceItem {
  name      String
  quantity  Int
  price     Float
  total     Float
  tax       Float
}

model CustomFee {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId
  settingsId    String   @db.ObjectId
  settings      RestaurantSettings @relation(fields: [settingsId], references: [id], onDelete: Cascade)
  
  name          String   // z.B. "Service-Gebühr", "Bearbeitungsgebühr", "Liefergebühr"
  description   String?  // Optionale Beschreibung
  type          String   @default("PERCENT") // PERCENT or FIXED
  value         Float    // Prozentsatz oder fester Betrag
  enabled       Boolean  @default(true)
  sortOrder     Int      @default(0)
  
  // Bedingungen
  minOrderAmount Float?  // Mindestbestellwert für diese Gebühr
  maxOrderAmount Float?  // Maximalbestellwert für diese Gebühr
  applyToDelivery Boolean @default(true)
  applyToDineIn   Boolean @default(true)
  applyToTakeaway Boolean @default(true)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Payment {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId
  restaurantId  String   @db.ObjectId
  restaurant    Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)

  amount        Float
  currency      String   @default("EUR")
  status        String   @default("PENDING") // PENDING, SUCCESS, FAILED, REFUNDED
  type          String   // ORDER, SUBSCRIPTION, SETUP_FEE

  // Stripe
  stripePaymentId String?
  stripeInvoiceId String?

  description   String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// Temporary storage for cart data before payment is confirmed
model PendingPayment {
  id              String   @id @default(auto()) @map("_id") @db.ObjectId
  restaurantId    String   @db.ObjectId
  restaurant      Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)

  // Table info
  tableId         String?  @db.ObjectId
  tableNumber     Int?

  // Order data (stored as JSON)
  items           Json     // Cart items: [{menuItemId, quantity, variantId, extraIds, notes, unitPrice}]

  // Amounts
  subtotal        Float
  tax             Float
  serviceFee      Float    @default(0)
  tip             Float    @default(0)
  total           Float

  // Guest info
  guestName       String?
  guestEmail      String?
  guestPhone      String?

  // Payment tracking
  paymentIntentId String?

  // After order is created
  orderId         String?  @db.ObjectId
  orderNumber     String?

  // Timestamps
  createdAt       DateTime @default(now())
  expiresAt       DateTime // Auto-cleanup after 1 hour
}